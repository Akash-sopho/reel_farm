# AI Suggestion API Specification

## Overview

This document specifies the AI suggestion API endpoints for ReelForge. These endpoints provide AI-powered text and image suggestions for project slots using OpenAI's GPT-4o and DALL-E 3 models.

The API:
- Generates multiple text suggestions based on slot context and user hints
- Generates images from descriptions and stores them in MinIO
- Tracks all AI asset generation for cost reporting and rate limiting
- Enforces per-user rate limits and cost guards to prevent abuse

Base path: `/api/ai`

---

## Core Concepts

### AI Assets

An **AI asset** is a suggestion generated by the AI service. It can be:
- **TEXT**: A text suggestion for a text slot
- **IMAGE**: An image file generated and stored in MinIO, ready to use in an image slot

### Rate Limits

The API enforces per-user rate limits:
- **Text suggestions**: 10 requests per minute per user
- **Image suggestions**: 5 requests per minute per user

Rate limit resets every minute. If a user exceeds the limit, the request fails with `RATE_LIMITED` error.

### Cost Guards

The API tracks token usage and cost per user:
- **Text suggestions**: Uses GPT-4o, typical cost ~$0.00150 per 3 suggestions
- **Image suggestions**: Uses DALL-E 3 (1024x1024), cost ~$0.020 per image

The implementation may include optional cost guards (total spend cap per user, per month) — **not enforced in Phase 2** but fields are tracked in the `AIAsset` table for future use.

### Prompt Templates

Prompt templates are stored in `src/backend/src/prompts/`:
- `src/backend/src/prompts/ai-text-suggestions.txt` — template for text suggestions
- `src/backend/src/prompts/ai-image-description.txt` — template for image generation

Each template contains:
- System role context
- Slot metadata placeholders (`{slotType}`, `{slotLabel}`, `{slotDescription}`)
- User hint placeholder (`{userHint}`)
- Output format instructions (e.g., "return JSON array of 3 suggestions")

---

## Data Types

### AIAsset Model

```typescript
interface AIAsset {
  id: string;                 // UUID
  projectId: string;          // foreign key to projects
  slotId: string;             // slot ID within the project
  type: 'TEXT' | 'IMAGE';     // asset type
  prompt: string;             // the final prompt sent to OpenAI
  outputUrl?: string;         // URL to the generated asset (MinIO key or S3 URL)
  tokensUsed?: number;        // tokens consumed (text only; images tracked separately)
  cost?: number;              // estimated cost in USD
  createdAt: string;          // ISO 8601
}
```

### Error Response

```typescript
interface ErrorResponse {
  error: string;
  code: string;
  details?: Record<string, string>;
}
```

---

## Endpoints

### 1. POST /api/ai/suggest/text — Generate Text Suggestions

**Purpose:** Generate 3 text suggestions for a text slot using GPT-4o.

**Request:**

```typescript
POST /api/ai/suggest/text
Content-Type: application/json
Authorization: Bearer <token>

{
  "projectId": "proj-abc123",
  "slotId": "headline",
  "hint": "Make it energetic and fun"  // optional
}
```

**Request Body Schema:**

```typescript
interface TextSuggestionRequest {
  projectId: string;  // must exist and belong to authenticated user
  slotId: string;     // must exist in the project's template slots
  hint?: string;      // optional user hint (max 200 chars)
}
```

**Response (200 OK):**

```json
{
  "suggestions": [
    "Transform Your Content in Minutes",
    "Create Viral Videos Effortlessly",
    "Elevate Your Social Game Today"
  ],
  "assetId": "ai-asset-xyz123",
  "tokensUsed": 145,
  "cost": 0.00217
}
```

**Response Schema:**

```typescript
interface TextSuggestionResponse {
  suggestions: string[];    // array of 3 text suggestions
  assetId: string;          // ID of the stored AIAsset
  tokensUsed: number;       // tokens used by GPT-4o
  cost: number;             // cost in USD
}
```

**Status Codes:**

| Code | Meaning |
|------|---------|
| 200 | Suggestions generated |
| 400 | Validation error (missing fields, invalid slot) |
| 401 | Unauthorized (missing/invalid token) |
| 404 | Project or slot not found |
| 429 | Rate limit exceeded (10/min per user) |
| 500 | OpenAI API error |

**Error Response (400 - Validation):**

```json
{
  "error": "Validation failed",
  "code": "VALIDATION_ERROR",
  "details": {
    "slotId": "Slot 'unknown' does not exist in project template",
    "hint": "Hint must be <= 200 characters"
  }
}
```

**Error Response (404 - Not Found):**

```json
{
  "error": "Project not found",
  "code": "NOT_FOUND",
  "details": { "projectId": "proj-xyz" }
}
```

**Error Response (429 - Rate Limited):**

```json
{
  "error": "Rate limit exceeded",
  "code": "RATE_LIMITED",
  "details": {
    "limit": 10,
    "window": "1 minute",
    "resetAt": "2026-02-23T10:35:00Z"
  }
}
```

**Error Response (500 - OpenAI Error):**

```json
{
  "error": "Failed to generate suggestions",
  "code": "OPENAI_ERROR",
  "details": {
    "openaiMessage": "Rate limit exceeded",
    "openaiCode": "rate_limit_exceeded"
  }
}
```

---

### 2. POST /api/ai/suggest/image — Generate Image

**Purpose:** Generate an image for an image slot using DALL-E 3 and store in MinIO.

**Request:**

```typescript
POST /api/ai/suggest/image
Content-Type: application/json
Authorization: Bearer <token>

{
  "projectId": "proj-abc123",
  "slotId": "background-image",
  "prompt": "Sunset over a mountain valley, warm colors, cinematic"
}
```

**Request Body Schema:**

```typescript
interface ImageSuggestionRequest {
  projectId: string;  // must exist and belong to authenticated user
  slotId: string;     // must exist and be type 'image' in template
  prompt: string;     // image description (max 1000 chars)
}
```

**Response (200 OK):**

```json
{
  "imageUrl": "https://minio.local/reelforge/ai-assets/ai-asset-xyz456.png",
  "assetId": "ai-asset-xyz456",
  "cost": 0.020
}
```

**Response Schema:**

```typescript
interface ImageSuggestionResponse {
  imageUrl: string;   // presigned URL to the generated image in MinIO
  assetId: string;    // ID of the stored AIAsset
  cost: number;       // cost in USD (DALL-E 3 @ 1024x1024)
}
```

**Status Codes:**

| Code | Meaning |
|------|---------|
| 200 | Image generated and stored |
| 400 | Validation error (missing fields, invalid slot, wrong slot type) |
| 401 | Unauthorized |
| 404 | Project or slot not found |
| 429 | Rate limit exceeded (5/min per user) |
| 500 | DALL-E API error or storage failure |

**Error Response (400 - Slot Type Mismatch):**

```json
{
  "error": "Validation failed",
  "code": "VALIDATION_ERROR",
  "details": {
    "slotId": "Slot 'headline' is type 'text', not 'image'"
  }
}
```

**Error Response (429 - Rate Limited):**

```json
{
  "error": "Rate limit exceeded",
  "code": "RATE_LIMITED",
  "details": {
    "limit": 5,
    "window": "1 minute",
    "resetAt": "2026-02-23T10:35:00Z"
  }
}
```

**Error Response (500 - DALL-E Error):**

```json
{
  "error": "Failed to generate image",
  "code": "OPENAI_ERROR",
  "details": {
    "openaiMessage": "Your request was rejected as a result of our safety system",
    "openaiCode": "content_policy_violation"
  }
}
```

**Error Response (500 - Storage Error):**

```json
{
  "error": "Failed to store generated image",
  "code": "STORAGE_ERROR",
  "details": {
    "message": "MinIO bucket not accessible"
  }
}
```

---

## Validation Rules

### Text Suggestion (`POST /api/ai/suggest/text`)

1. **projectId**
   - Required, non-empty string
   - Must reference an existing project
   - Project must belong to authenticated user (401 if not)

2. **slotId**
   - Required, non-empty string
   - Must exist in project's template schema
   - Must be type `text` in the template (return 400 if not)

3. **hint**
   - Optional, max 200 characters
   - Will be trimmed before sending to GPT-4o

### Image Suggestion (`POST /api/ai/suggest/image`)

1. **projectId**
   - Required, non-empty string
   - Must reference an existing project
   - Project must belong to authenticated user

2. **slotId**
   - Required, non-empty string
   - Must exist in project's template schema
   - Must be type `image` (return 400 if type is `text`, `video`, `audio`)

3. **prompt**
   - Required, non-empty string after trim
   - Max 1000 characters
   - Will be used as-is for DALL-E 3

---

## Rate Limiting Implementation

Rate limits are **per-user, per-minute**. Implementation approach:

1. **Key format**: `ai-limit:{userId}:{endpoint}` (e.g., `ai-limit:user-123:text`)
2. **Storage**: Redis with 60-second expiry
3. **Increment on request**: Check count, increment, check if exceeded
4. **Reset**: Redis key expires after 60 seconds (automatic)

Example logic:

```typescript
const key = `ai-limit:${userId}:${endpoint}`;
const count = await redis.incr(key);
if (count === 1) {
  await redis.expire(key, 60);  // set expiry on first request of minute
}
const isLimited = count > LIMIT[endpoint];  // 10 for text, 5 for image
```

Return `429` with resetAt = `now() + (60 - secondsInCurrentMinute)`.

---

## Prompt Template Files

### `src/backend/src/prompts/ai-text-suggestions.txt`

Format: Plain text with placeholders.

```
System context:
You are a content suggestion assistant for social media video creators using the ReelForge platform.
Your task is to generate creative, engaging text suggestions for a specific content slot.

Slot Information:
- Type: {slotType}
- Label: {slotLabel}
- Description: {slotDescription}

User Hint: {userHint}

Task:
Generate exactly 3 unique, varied text suggestions suitable for this slot.
Return as a JSON array of strings: ["suggestion1", "suggestion2", "suggestion3"]

Requirements:
- Suggestions should be concise (under 100 characters each)
- Vary in tone and approach
- Be creative and engaging for social media
- Consider current trends if relevant
- Return ONLY the JSON array, no other text
```

### `src/backend/src/prompts/ai-image-description.txt`

Format: Plain text with placeholders.

```
You are an image generation assistant for social media video creators.
Generate a detailed visual description suitable for DALL-E 3.

Slot Information:
- Label: {slotLabel}
- Description: {slotDescription}

User Prompt: {prompt}

Create a detailed, visual description that:
- Enhances the user's prompt with visual specifics
- Suggests composition, lighting, mood, and style
- Is 1-3 sentences long
- Returns ONLY the enhanced description text, no preamble
```

---

## Implementation Notes

### Authentication

All endpoints require `Authorization: Bearer <token>` header. Extract `userId` from token to:
- Filter projects (only access own projects)
- Track rate limits per user
- Store projectId/userId relationship in AIAsset

### Prompt Construction

1. Load template file from `src/backend/src/prompts/`
2. Replace placeholders with actual values:
   - `{slotType}` → slot.type from template
   - `{slotLabel}` → slot.label from template
   - `{slotDescription}` → slot.description (if available)
   - `{userHint}` or `{prompt}` → user input
3. Send final prompt to OpenAI

### Storage for Generated Images

- MinIO key format: `ai-assets/{assetId}.png` (UUID)
- Generate presigned URL with 7-day expiry
- Store full URL in `AIAsset.outputUrl` field
- URL can be used directly in project slots

### Cost Tracking

Store in `AIAsset` table for reporting:
- GPT-4o text: ~$0.00150 per 3-suggestion request (estimated based on ~145 tokens)
- DALL-E 3: $0.020 per image (fixed, 1024x1024)

Track actual `tokensUsed` from GPT-4o API response; calculate cost based on pricing tier.

### Error Handling

- **Validation errors** (400): Return immediately with field-level details
- **OpenAI errors** (5xx): Catch, log, return 500 with openaiMessage and openaiCode
- **Storage errors** (5xx): Return 500 with descriptive message
- **Rate limit** (429): Return with resetAt timestamp

---

## Example Workflows

### Workflow 1: Generate Text Suggestions

```bash
curl -X POST http://localhost:3001/api/ai/suggest/text \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer user-token-xyz" \
  -d '{
    "projectId": "proj-123",
    "slotId": "headline",
    "hint": "Make it catchy"
  }'

# Response:
# {
#   "suggestions": [
#     "Your Next Big Hit",
#     "Create. Share. Inspire.",
#     "Unleash Your Creativity"
#   ],
#   "assetId": "ai-asset-001",
#   "tokensUsed": 142,
#   "cost": 0.00213
# }
```

### Workflow 2: Generate Image

```bash
curl -X POST http://localhost:3001/api/ai/suggest/image \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer user-token-xyz" \
  -d '{
    "projectId": "proj-123",
    "slotId": "background",
    "prompt": "Sunset over tropical beach, warm tones"
  }'

# Response:
# {
#   "imageUrl": "https://minio.local/reelforge/ai-assets/ai-asset-002.png?expires=...",
#   "assetId": "ai-asset-002",
#   "cost": 0.020
# }
```

### Workflow 3: Rate Limit Hit

```bash
# 11th text request in a minute:
curl -X POST http://localhost:3001/api/ai/suggest/text \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer user-token-xyz" \
  -d '{...}'

# Response (429):
# {
#   "error": "Rate limit exceeded",
#   "code": "RATE_LIMITED",
#   "details": {
#     "limit": 10,
#     "window": "1 minute",
#     "resetAt": "2026-02-23T10:35:00Z"
#   }
# }
```

---

## Future Enhancements

- **Cost caps**: Implement per-user monthly spend limit
- **Caching**: Cache image generations for identical prompts to reduce costs
- **Feedback loop**: Store which suggestions users actually selected for training
- **Bulk generation**: Endpoint to generate suggestions for all slots in a project
- **Custom models**: Support custom fine-tuned models per template category
