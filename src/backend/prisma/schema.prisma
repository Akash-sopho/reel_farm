// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  projects        Project[]
  collectedVideos CollectedVideo[]
}

model Template {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  category         String
  tags             String[] @default([])
  description      String   @default("")
  schema           Json     // TemplateSchema document
  thumbnailUrl     String?
  durationSeconds  Int
  isPublished      Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  projects Project[]

  @@index([category])
  @@index([isPublished])
}

model Project {
  id        String   @id @default(cuid())
  userId    String
  templateId String
  name      String
  slotFills Json     @default("[]") // SlotFill[] array
  musicUrl  String?
  settings  Json     @default("{}")
  status    String   @default("draft") // 'draft' | 'ready' | 'rendering' | 'done'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  template          Template           @relation(fields: [templateId], references: [id])
  renders           Render[]
  voiceoverClips    VoiceoverClip[]
  aiAssets          AIAsset[]
  publishLogs       PublishLog[]

  @@index([userId])
  @@index([templateId])
  @@index([status])
}

model Render {
  id           String   @id @default(cuid())
  projectId    String
  status       String   @default("PENDING") // 'PENDING' | 'PROCESSING' | 'DONE' | 'FAILED'
  outputUrl    String?
  errorMessage String?
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime @default(now())

  // Relations
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  publishLogs PublishLog[]

  @@index([projectId])
  @@index([status])
}

model CollectedVideo {
  id            String   @id @default(cuid())
  userId        String?
  sourceUrl     String
  platform      String   // 'instagram' | 'tiktok'
  title         String?
  caption       String?
  videoUrl      String
  thumbnailUrl  String?
  durationSeconds Int?
  tags          String[] @default([])
  status        String   @default("FETCHING") // 'FETCHING' | 'READY' | 'FAILED'
  createdAt     DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([platform])
  @@index([status])
}

model MusicTrack {
  id              String   @id @default(cuid())
  title           String
  artist          String
  url             String
  durationSeconds Int
  bpm             Int?
  mood            String?
  genre           String?
  tags            String[] @default([])
  isActive        Boolean  @default(true)

  @@index([genre])
  @@index([mood])
  @@index([isActive])
}

model VoiceoverClip {
  id              String   @id @default(cuid())
  projectId       String
  url             String
  durationSeconds Int
  createdAt       DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model PublishLog {
  id            String   @id @default(cuid())
  projectId     String
  renderId      String
  platform      String   // 'instagram' | 'tiktok'
  status        String   @default("pending") // 'pending' | 'published' | 'failed' | 'scheduled'
  externalId    String?
  errorMessage  String?
  scheduledAt   DateTime?
  publishedAt   DateTime?
  createdAt     DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  render  Render  @relation(fields: [renderId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([renderId])
  @@index([platform])
  @@index([status])
}

model AIAsset {
  id        String   @id @default(cuid())
  projectId String
  slotId    String
  type      String   // 'TEXT' | 'IMAGE'
  prompt    String
  outputUrl String?
  tokensUsed Int?
  cost      Float?
  createdAt DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([slotId])
  @@index([type])
}
